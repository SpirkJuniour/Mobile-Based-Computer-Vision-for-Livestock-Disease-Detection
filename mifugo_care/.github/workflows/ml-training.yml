name: ML Model Training

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type to train'
        required: true
        type: choice
        options:
          - classification
          - detection
          - both
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '50'
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  train-models:
    name: Train ML Models
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ml/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        working-directory: ./ml
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Train Models
        working-directory: ./ml
        run: |
          if [ "${{ inputs.model_type }}" = "both" ] || [ "${{ inputs.model_type }}" = "classification" ]; then
            python train_classification_only.py --epochs ${{ inputs.epochs || 50 }}
          fi
          if [ "${{ inputs.model_type }}" = "both" ] || [ "${{ inputs.model_type }}" = "detection" ]; then
            python train_all.py --epochs ${{ inputs.epochs || 50 }}
          fi
        continue-on-error: true
      
      - name: Export ONNX Models
        working-directory: ./ml
        run: |
          python export_existing_models.py
        continue-on-error: true
      
      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: onnx-models
          path: |
            ml/runs/**/*.onnx
            assets/models/*.onnx
          retention-days: 30
        if: success()
      
      - name: Check Model Accuracy
        working-directory: ./ml
        run: |
          python check_accuracy.py
        continue-on-error: true
      
      - name: Create Summary
        run: |
          echo "## ML Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Model Type: ${{ inputs.model_type || 'both' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Epochs: ${{ inputs.epochs || 50 }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

